version: '3.8'

services:
  backend:
    image: pdv-pelg-backend:latest
    networks:
      - network_public
    environment:
      # Supabase
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET}

      # Master Database
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}

      # Encryption
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}

      # Server
      - PORT=3000
      - NODE_ENV=production
      - CORS_ORIGIN=${CORS_ORIGIN}
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.pdv-backend.rule=Host(`${DOMAIN}`) && PathPrefix(`/api`)"
        - "traefik.http.routers.pdv-backend.entrypoints=websecure"
        - "traefik.http.routers.pdv-backend.tls.certresolver=letsencrypt"
        - "traefik.http.services.pdv-backend.loadbalancer.server.port=3000"

  frontend:
    image: pdv-pelg-frontend:latest
    networks:
      - network_public
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.pdv-frontend.rule=Host(`${DOMAIN}`)"
        - "traefik.http.routers.pdv-frontend.entrypoints=websecure"
        - "traefik.http.routers.pdv-frontend.tls.certresolver=letsencrypt"
        - "traefik.http.services.pdv-frontend.loadbalancer.server.port=80"

networks:
  network_public:
    external: true
